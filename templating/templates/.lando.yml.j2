name: {{ app }} ######## ‚ö†Ô∏èPLEASE CHANGE THIS TO YOUR AWESOME APP's NAME!‚ö†Ô∏è
recipe: wordpress
config:
  via: nginx
  php: "{{ php }}"
  webroot: wordpress
  database: mariadb
  xdebug: true
  config:
    php: .lando/php.ini
    vhosts: .lando/nginx.conf
services:
  rediscache:
    type: redis
  mailhog:
    type: mailhog
    portforward: false
    hogfrom:
      - appserver
  appserver:
    overrides:
      environment:
        # Make this environment variable empty or else runtime xdebug mode change will not work
        XDEBUG_MODE: ''
        # Support debugging Drush with XDEBUG.
        PHP_IDE_CONFIG: "serverName=appserver"
        PROFILER_OUTPUT_DIR: "profiler-output" # If changing this value, change in .gitignore also
      volumes:
        # LINK CORE FILES. DON'T LINK THE ENTIRE DIRECTORY, BECAUSE THAT CAN CAUSE MANY IMPORTANT CORE LOCAL FILES TO BE OVERRIDDEN.
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-admin:/app/wordpress/wp-admin'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-includes:/app/wordpress/wp-includes'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/index.php:/app/wordpress/index.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-activate.php:/app/wordpress/wp-activate.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-blog-header.php:/app/wordpress/wp-blog-header.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-comments-post.php:/app/wordpress/wp-comments-post.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-cron.php:/app/wordpress/wp-cron.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-links-opml.php:/app/wordpress/wp-links-opml.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-load.php:/app/wordpress/wp-load.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-login.php:/app/wordpress/wp-login.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-mail.php:/app/wordpress/wp-mail.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-settings.php:/app/wordpress/wp-settings.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-signup.php:/app/wordpress/wp-signup.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/wp-trackback.php:/app/wordpress/wp-trackback.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}/xmlrpc.php:/app/wordpress/xmlrpc.php'
        - '~/wordpress/wordpress.setup-DO-NOT-DELETE/wordpress-core-{{ wp }}:/app/wordpress'
        # LINK LANDO CONFIG FILES.
        - '.lando/wp-cli.yml:/wp-cli.yml'
        # LINK WP-CONTENT DIRECTORY.
        - './wp-content:/app/wordpress/wp-content'
        # LINK WP-CONFIG.PHP FILE.
        - './wp-config.php:/app/wordpress/wp-config.php'
    # Have a look at this for better idea of build states:
    # Not needed because we are creating having wordpress-core already downloaded.
    # build:
    #   - wp core download --version=5.8.3 --force --skip-content
    build_as_root:
      - curl -sL https://deb.nodesource.com/setup_{{ node }} | bash -
      - apt-get install -y nodejs
    run:
      - sleep 2 # For some reason, we have to wait at least a second till database is up.
      - | # Create WordPress config file and add necessary constants and custom config. Currently this will not work because the volume mapping occurs before the file is created.üêõüêõ
        if test -f "$LANDO_WEBROOT/wp-config.php"; then
          echo "Config file already exists."
        else
        wp config create --dbhost=database --dbname=wordpress --dbuser=wordpress --dbpass=wordpress --dbprefix=wp_ --force --extra-php <<PHP
        \$redis_server = array(
          'host'     => 'rediscache',
          'port'     => 6379,
        );
        PHP
        fi
      - | # Let's check if WordPress is not installed, then install it
        if ! wp core is-installed; then
          {{ core_install_command }}
          {{ query_monitor_install_command }}
        fi
tooling:
  xdebug:
    description: Loads Xdebug in the selected mode.
    cmd:
      - appserver: /app/.lando/xdebug.sh
    user: root
proxy:
  appserver_nginx:
    - "{{ app }}.lndo.site"
    - "*.{{ app }}.lndo.site"